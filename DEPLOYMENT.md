# Deployment Guide

## Quick Start

The entire deployment is automated by shell scripts. For a fresh server:

```bash
curl -fsSL https://raw.githubusercontent.com/maidevberlin/logikids/main/install.sh | bash
```

Or clone first, then install:

```bash
git clone https://github.com/maidevberlin/logikids.git
cd logikids
./install.sh
```

That's it! The script handles everything:

- ✅ Docker installation
- ✅ Secure secret generation (`.env` file)
- ✅ AI provider configuration
- ✅ Building containers
- ✅ Starting services
- ✅ Optional: Nginx + SSL setup

## Architecture Overview

### URL Configuration

**Development** (`localhost:5153`):

```
Browser → Vite dev server → Proxy /api → backend-dev:3000
```

**Local Production** (`localhost:5154`):

```
Browser → Frontend Container (Nginx) → Static files
                                      → /api → backend-prod:3000
```

**Server Production** (`yourdomain.com`):

```
Browser → Host Nginx (SSL) → Frontend Container (Nginx) → Static files
                                                        → /api → backend-prod:3000
```

### Port Mapping

| Service      | Dev Port | Prod Port | Container Port |
| ------------ | -------- | --------- | -------------- |
| Frontend     | 5153     | 5154      | 80             |
| Backend      | 5175     | 5176      | 3000           |
| PostgreSQL   | 5432     | 5432      | 5432           |
| Adminer      | 8080     | -         | 5480           |
| Backend Test | -        | -         | 3000           |

## Installation Scripts

### `install.sh`

**What it does:**

1. Installs Docker + Docker Compose if needed
2. Clones/updates repository
3. **Generates secure secrets automatically** (if `.env` doesn't exist)
   - Random PostgreSQL password (32 chars)
   - Random JWT secret (64 chars)
4. Prompts for AI provider configuration (Anthropic/OpenAI/Ollama)
5. Creates `packages/backend/config.yaml` with AI settings
6. Builds Docker containers
7. Starts production services
8. Optionally sets up Nginx with SSL

**Usage:**

```bash
./install.sh
```

### `setup-nginx.sh`

**What it does:**

1. Installs Nginx + Certbot
2. Prompts for domain name
3. Obtains SSL certificate via Let's Encrypt
4. Creates Nginx config that proxies to frontend container
5. Frontend container's internal Nginx handles `/api` → backend routing

**Usage:**

```bash
sudo ./setup-nginx.sh
```

**Important:** This script only proxies to the frontend container. The frontend's internal Nginx configuration (`packages/frontend/nginx.conf`) handles proxying `/api` requests to the backend.

**Generated Nginx config:**

```nginx
server {
    listen 443 ssl;
    server_name yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # Proxy EVERYTHING to frontend container
    location / {
        proxy_pass http://localhost:5154;
        # ... headers and timeouts
    }
}
```

### `update.sh`

**What it does:**

1. Pulls latest code from git
2. Calls `restart.sh`

**Usage:**

```bash
./update.sh
```

### `restart.sh`

**What it does:**

1. Stops all containers
2. Rebuilds frontend-prod and backend-prod
3. Starts postgres, frontend-prod, backend-prod

**Usage:**

```bash
./restart.sh
```

## Configuration Files

### `.env` (Root Directory)

**Auto-generated by `install.sh` if it doesn't exist:**

```bash
# Database Configuration
POSTGRES_PASSWORD=<random-32-chars>

# JWT Secret for authentication
JWT_SECRET=<random-64-chars>

# Generated on <timestamp>
```

**Manual creation:**

```bash
cp .env.example .env
# Edit with secure values
```

**Generate secure secrets manually:**

```bash
# PostgreSQL password
openssl rand -base64 32 | tr -d "=+/" | cut -c1-32

# JWT secret
openssl rand -base64 64 | tr -d "=+/" | cut -c1-64
```

### `packages/backend/config.yaml`

**Created by `install.sh` during AI configuration:**

```yaml
server:
  port: 3000

ai:
  provider: openai # or anthropic
  openai:
    apiKey: sk-...
    model: gpt-5
  # OR
  anthropic:
    apiKey: sk-ant-...
    model: claude-sonnet-4.5
    maxTokens: 4096
    temperature: 0.7
```

### `packages/frontend/nginx.conf`

**Pre-configured reverse proxy** (already in repo):

```nginx
location /api {
    proxy_pass http://backend-prod:3000;
    # ... headers
}
```

This file is copied into the Docker image during build. No manual configuration needed!

## Deployment Workflow

### Initial Server Setup

```bash
# 1. Run install script (handles everything)
./install.sh

# 2. (Optional) Set up SSL
sudo ./setup-nginx.sh
```

### Updating Deployed Application

```bash
# Simple update
./update.sh

# Or manually:
git pull
./restart.sh
```

### Manual Deployment Steps (if needed)

```bash
# 1. Update code
git pull

# 2. Rebuild containers
docker compose build frontend-prod backend-prod

# 3. Restart services
docker compose restart frontend-prod backend-prod

# 4. Check status
docker compose ps
docker compose logs -f frontend-prod backend-prod
```

## Environment-Specific Details

### Development

**Start:**

```bash
docker compose up frontend-dev backend-dev
```

**Access:**

- Frontend: http://localhost:5153
- Backend API: http://localhost:5175/api
- Frontend automatically proxies `/api` to backend-dev

**Configuration:**

- Vite proxy in `packages/frontend/vite.config.ts`
- Hot reload enabled
- Uses `.env` for database password

### Production (Local Testing)

**Start:**

```bash
docker compose up -d frontend-prod backend-prod
```

**Access:**

- Frontend: http://localhost:5154
- Backend API: http://localhost:5154/api (proxied through frontend)

**Configuration:**

- Nginx proxy in `packages/frontend/nginx.conf`
- Built static files
- Uses `.env` for database password + JWT secret

### Production (Server)

**Access:**

- Frontend: https://yourdomain.com
- Backend API: https://yourdomain.com/api

**Configuration:**

- Host Nginx proxies to `localhost:5154`
- Frontend container Nginx handles internal routing
- SSL via Let's Encrypt
- Uses `.env` for secrets

## Reverse Proxy Architecture

### Development

```
Vite dev server (packages/frontend/vite.config.ts)
  ├─ Static files (HMR)
  └─ /api → backend-dev:3000
```

### Production

```
Host Nginx (/etc/nginx/sites-available/yourdomain.com)
  └─ / → Frontend Container:5154
        └─ Container Nginx (packages/frontend/nginx.conf)
              ├─ Static files
              └─ /api → backend-prod:3000
```

**Key Point:** The host Nginx ONLY proxies to the frontend container. The frontend container's internal Nginx handles the `/api` → backend routing.

## Troubleshooting

### Secrets Not Generated

**Problem:** `.env` file is missing or has default values

**Solution:**

```bash
# Delete existing .env (if it has wrong values)
rm .env

# Re-run install to regenerate
./install.sh
```

Or generate manually:

```bash
echo "POSTGRES_PASSWORD=$(openssl rand -base64 32 | tr -d '=+/' | cut -c1-32)" > .env
echo "JWT_SECRET=$(openssl rand -base64 64 | tr -d '=+/' | cut -c1-64)" >> .env
```

### Frontend Shows 404 for API Calls

**Problem:** Nginx config missing or outdated

**Solution:**

```bash
# Rebuild frontend with latest nginx.conf
docker compose build --no-cache frontend-prod
docker compose restart frontend-prod

# Check nginx config in container
docker compose exec frontend-prod cat /etc/nginx/conf.d/default.conf
```

### SSL Certificate Issues

**Problem:** Let's Encrypt certificate failed or expired

**Solution:**

```bash
# Renew certificate
sudo certbot renew

# Or re-run setup
sudo ./setup-nginx.sh

# Check certificate status
sudo certbot certificates
```

### Backend Not Reachable

**Problem:** Docker network issue or backend crashed

**Solution:**

```bash
# Check all services
docker compose ps

# Check logs
docker compose logs backend-prod

# Restart everything
docker compose down
docker compose up -d postgres frontend-prod backend-prod
```

### Database Connection Errors

**Problem:** Wrong password or database not initialized

**Solution:**

```bash
# Check postgres is healthy
docker compose ps postgres

# Check logs
docker compose logs postgres

# Verify .env has POSTGRES_PASSWORD
cat .env

# Restart with fresh database (⚠️ DATA LOSS)
docker compose down -v
docker compose up -d postgres
sleep 10  # Wait for postgres
docker compose up -d frontend-prod backend-prod
```

## Monitoring

### Check Service Status

```bash
docker compose ps
```

### View Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f frontend-prod
docker compose logs -f backend-prod

# Last 100 lines
docker compose logs --tail 100 frontend-prod
```

### Health Checks

```bash
# Frontend health
curl http://localhost:5154/health

# API health
curl http://localhost:5154/api/task/subjects

# Database connection (from inside backend)
docker compose exec backend-prod bun -e "import {pool} from './database/db'; const r = await pool.query('SELECT NOW()'); console.log(r.rows[0])"
```

## Backup & Restore

### Backup PostgreSQL

```bash
docker compose exec postgres pg_dump -U logikids logikids > backup_$(date +%Y%m%d_%H%M%S).sql
```

### Restore PostgreSQL

```bash
docker compose exec -T postgres psql -U logikids logikids < backup_20250101_120000.sql
```

### Backup .env and config.yaml

```bash
cp .env .env.backup
cp packages/backend/config.yaml packages/backend/config.yaml.backup
```

## Security Checklist

- [x] Random secure passwords generated automatically
- [ ] Change default `POSTGRES_PASSWORD` (if using `.env.example`)
- [ ] Change default `JWT_SECRET` (if using `.env.example`)
- [ ] Configure firewall (allow only 22, 80, 443)
- [ ] Set up automatic security updates
- [ ] Configure SSL certificates
- [ ] Review `config.yaml` for sensitive data
- [ ] Regular database backups
- [ ] Monitor logs for suspicious activity

## Support

For issues or questions:

- Check logs: `docker compose logs -f`
- Review configuration: `cat .env` and `cat packages/backend/config.yaml`
- Verify containers: `docker compose ps`
- GitHub Issues: https://github.com/maidevberlin/logikids/issues
