#!/bin/bash
# Invite Code Manager - Wrapper Script
# Usage: ./invite <command> [args]

set -e

# Determine environment (default: dev)
CONTAINER="backend-dev"
if [[ "$1" == "--prod" ]] || [[ "$1" == "-p" ]]; then
  CONTAINER="backend"
  shift
fi

COMMAND="$1"
shift || true

case "$COMMAND" in
  list|l)
    docker compose exec $CONTAINER bun run src/scripts/invite-codes.ts list
    ;;

  create|c)
    NOTE="$*"
    if [ -z "$NOTE" ]; then
      docker compose exec $CONTAINER bun run src/scripts/invite-codes.ts create
    else
      docker compose exec $CONTAINER bun run src/scripts/invite-codes.ts create "$NOTE"
    fi
    ;;

  remove|rm)
    CODE="$1"
    if [ -z "$CODE" ]; then
      echo "‚ùå Error: Please provide a code to remove"
      echo "Usage: ./invite remove <code>"
      exit 1
    fi
    docker compose exec $CONTAINER bun run src/scripts/invite-codes.ts remove "$CODE"
    ;;

  clear)
    docker compose exec $CONTAINER bun run src/scripts/invite-codes.ts clear
    ;;

  help|h|"")
    cat << EOF

üì® Invite Code Manager

Usage:
  ./invite [--prod|-p] <command> [args]

Commands:
  list                    - List all invite codes (alias: l)
  create [note]           - Create new invite code (alias: c)
  remove <code>           - Remove invite code (alias: rm)
  clear                   - Delete ALL invite codes (with confirmation)

Flags:
  --prod, -p             - Use production environment (default: dev)

Examples:
  ./invite list                           # List dev codes
  ./invite --prod list                    # List production codes
  ./invite create "For Maria's family"    # Create dev code
  ./invite -p create "Production user"    # Create production code
  ./invite c "Test user"
  ./invite --prod remove ABCD-1234        # Remove production code
  ./invite rm ABCD-1234
  ./invite clear

Note: Used codes are automatically deleted after successful validation.

EOF
    ;;

  *)
    echo "‚ùå Unknown command: $COMMAND"
    echo "Run './invite help' for usage information"
    exit 1
    ;;
esac
