services:
  frontend-dev:
    build:
      context: ./packages/frontend
      dockerfile: Dockerfile.dev
    ports:
      - '5153:80'
    volumes:
      - ./packages/frontend:/app
    environment:
      - NODE_ENV=development
    depends_on:
      - backend-dev
    networks:
      - app-network

  frontend-prod:
    build:
      context: .
      dockerfile: packages/frontend/Dockerfile.prod
    ports:
      - '5154:80'
    environment:
      - NODE_ENV=production
    depends_on:
      - backend-prod
    networks:
      - app-network

  backend-dev:
    build:
      context: ./packages/backend
      dockerfile: Dockerfile.dev
    ports:
      - '5175:3000'
    volumes:
      - ./packages/backend:/app
      - ./packages/content:/content
      - ./packages/frontend/public/locales:/frontend/public/locales:ro
      - ./scripts:/app/scripts
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://logikids:${POSTGRES_PASSWORD:-development}@postgres:5432/logikids
      - JWT_SECRET=${JWT_SECRET:-logikids-dev-secret-change-in-production}
      # AI Provider Configuration
      - AI_PROVIDER=${AI_PROVIDER:-ollama}
      # Ollama
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama2}
      - OLLAMA_TEMPERATURE=${OLLAMA_TEMPERATURE:-}
      - OLLAMA_TOP_K=${OLLAMA_TOP_K:-}
      - OLLAMA_TOP_P=${OLLAMA_TOP_P:-}
      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - OPENAI_TEMPERATURE=${OPENAI_TEMPERATURE:-}
      - OPENAI_MAX_TOKENS=${OPENAI_MAX_TOKENS:-}
      - OPENAI_TOP_P=${OPENAI_TOP_P:-}
      # Anthropic
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-sonnet-4-5}
      - ANTHROPIC_MAX_TOKENS=${ANTHROPIC_MAX_TOKENS:-4096}
      - ANTHROPIC_TEMPERATURE=${ANTHROPIC_TEMPERATURE:-0.7}
      # Server
      - SERVER_PORT=${SERVER_PORT:-3000}
      # TTS
      - GOOGLE_CLOUD_TTS_API_KEY=${GOOGLE_CLOUD_TTS_API_KEY:-}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app-network

  backend-prod:
    build:
      context: ./packages/backend
      dockerfile: Dockerfile.prod
    ports:
      - '5176:3000'
    volumes:
      - ./packages/content:/content
      - ./packages/frontend/public/locales:/frontend/public/locales:ro
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://logikids:${POSTGRES_PASSWORD}@postgres:5432/logikids
      - JWT_SECRET=${JWT_SECRET}
      # AI Provider Configuration
      - AI_PROVIDER=${AI_PROVIDER}
      # Ollama
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama2}
      - OLLAMA_TEMPERATURE=${OLLAMA_TEMPERATURE:-}
      - OLLAMA_TOP_K=${OLLAMA_TOP_K:-}
      - OLLAMA_TOP_P=${OLLAMA_TOP_P:-}
      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - OPENAI_TEMPERATURE=${OPENAI_TEMPERATURE:-}
      - OPENAI_MAX_TOKENS=${OPENAI_MAX_TOKENS:-}
      - OPENAI_TOP_P=${OPENAI_TOP_P:-}
      # Anthropic
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-sonnet-4-5}
      - ANTHROPIC_MAX_TOKENS=${ANTHROPIC_MAX_TOKENS:-4096}
      - ANTHROPIC_TEMPERATURE=${ANTHROPIC_TEMPERATURE:-0.7}
      # Server
      - SERVER_PORT=${SERVER_PORT:-3000}
      # TTS
      - GOOGLE_CLOUD_TTS_API_KEY=${GOOGLE_CLOUD_TTS_API_KEY:-}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app-network

  backend-test:
    build:
      context: ./packages/backend
      dockerfile: Dockerfile.test
    volumes:
      - ./packages/backend:/app
      - ./packages/content:/content
      - ./packages/frontend/public/locales:/frontend/public/locales:ro
    environment:
      - NODE_ENV=test
    networks:
      - app-network

  postgres:
    image: postgres:16-alpine
    container_name: logikids-postgres
    environment:
      POSTGRES_DB: logikids
      POSTGRES_USER: logikids
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-development}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./packages/backend/database/migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - '5432:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U logikids']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  adminer:
    image: adminer:latest
    container_name: logikids-adminer
    ports:
      - '8080:8080'
    environment:
      - ADMINER_DEFAULT_SERVER=postgres
      - ADMINER_DESIGN=nette
    depends_on:
      - postgres
    networks:
      - app-network

volumes:
  postgres-data:

networks:
  app-network:
    driver: bridge
