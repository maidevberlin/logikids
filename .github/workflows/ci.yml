name: CI

on:
  pull_request:
    branches: [main, dev]
  # Only run on push to main (post-merge verification)
  push:
    branches: [main]

env:
  # Use CI-specific secrets (not dev values, which are rejected by prod)
  # Note: Secret must NOT contain 'dev' or 'test' - prod validation rejects those
  JWT_SECRET: ${{ secrets.CI_JWT_SECRET || 'XkJ9mP2nL5vR8qW3yT6uI1oA4sD7fG0hKzMcNbVxQwErYtUiOpAsDfGhJkLzXcVb' }}
  POSTGRES_PASSWORD: ci_password_12345

jobs:
  validate:
    name: Validate Content
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install script dependencies
        working-directory: scripts
        run: bun install

      - name: Check concepts
        run: bun scripts/check-concepts.ts --all

      - name: Check translations
        run: bun scripts/check-translations.ts --all

      - name: Check orphaned translations
        run: bun scripts/check-orphaned-translations.ts --all

  build:
    name: Build Production Images
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend-prod
        uses: docker/build-push-action@v6
        with:
          context: .
          file: packages/frontend/Dockerfile.prod
          push: false
          tags: logikids-frontend-prod:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build backend-prod
        uses: docker/build-push-action@v6
        with:
          context: .
          file: packages/backend/Dockerfile.prod
          push: false
          tags: logikids-backend-prod:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

  integration:
    name: Integration Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Create .env file for CI
        run: |
          cat > .env << EOF
          JWT_SECRET=${{ env.JWT_SECRET }}
          POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }}
          AI_PROVIDER=ollama
          OLLAMA_HOST=http://localhost:11434
          EOF

      - name: Start services
        run: |
          docker compose up -d postgres
          docker compose up -d --build backend frontend

      - name: Wait for postgres
        run: |
          for i in {1..30}; do
            if docker compose exec -T postgres pg_isready -U logikids; then
              echo "Postgres is ready"
              break
            fi
            echo "Waiting for postgres... ($i/30)"
            sleep 2
          done

      - name: Wait for backend
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:5176/health > /dev/null 2>&1; then
              echo "Backend is healthy"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
          # Final check with output
          curl -f http://localhost:5176/health

      - name: Wait for frontend
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:5154 > /dev/null 2>&1; then
              echo "Frontend is serving"
              break
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep 2
          done
          # Final check
          curl -f http://localhost:5154 -o /dev/null

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Backend logs ==="
          docker compose logs backend --tail 100
          echo "=== Frontend logs ==="
          docker compose logs frontend --tail 100
          echo "=== Postgres logs ==="
          docker compose logs postgres --tail 50

      - name: Cleanup
        if: always()
        run: docker compose down -v

  publish:
    name: Publish Docker Images
    runs-on: ubuntu-latest
    needs: [validate, build, integration]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/frontend
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: packages/frontend/Dockerfile.prod
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/backend
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: packages/backend/Dockerfile.prod
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          cache-from: type=gha,mode=max
          cache-to: type=gha,mode=max
